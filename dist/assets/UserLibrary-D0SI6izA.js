import{_ as P,r as d,v as U,o as Y,c as T,b as w,d as s,e as n,t as c,w as u,s as D,g as i,j as Q,x as $,F as z,z as H,p as E,m as M,E as B}from"./index-BjpkzZGY.js";const F={class:"library"},O={class:"library-head"},K={class:"actions"},X={class:"price-filter"},J={class:"book-card"},q={class:"book-body"},ee={class:"author"},te={class:"publish"},ae={class:"price"},le={class:"stock-info"},se={class:"desc"},oe={class:"card-foot"},ne="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iMTQwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIGZpbGw9Im5vbmUiIHN0cm9rZT0ibm9uZSI+CiAgICA8cmVjdCB3aWR0aD0iOTYiIGhlaWdodD0iMTQwIiBmaWxsPSIjZTRlN2ViIiByeD0iMTIiLz4KICAgIDxyZWN0IHg9IjAiIHk9IjMwIiB3aWR0aD0iOTYiIGhlaWdodD0iMTA5IiBmaWxsPSIjY2RmMWY2IiByeD0iMTIiLz4KICAgIDx0ZXh0IHg9IjQ4IiB5PSI3NSIgc3R5bGU9ImZvbnQtc2l6ZToxNnB4O2ZpbGw6I0E1QTVCQTtmb250LXdlaWdodDpib2xkOyIgZGV2LWNoYXJhY3Rlcj0iYmVhdCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Tk8gQ09WRVI8L3RleHQ+CiAgPC9nPgo8L3N2Zz4=",re={__name:"UserLibrary",setup(ie){const p=d([]),b=d(""),m=d("all"),g=d(""),I=d(""),_=d(null),x=async()=>{try{const t=await D.get("/books");p.value=Array.isArray(t)?t.map(e=>({...e,price:Number(e.price??0),stock_total:Number(e.stock_total??0),stock_available:Number(e.stock_available??e.available??0)})):[]}catch(t){console.error("获取图书列表失败:",t),p.value=[]}},V=t=>{if(t===""||t===null||t===void 0)return null;const e=Number(t);return Number.isFinite(e)?e:null},L=U(()=>{const t=b.value.trim().toLowerCase(),e=V(g.value),o=V(I.value);return p.value.filter(l=>{const r=!t||(l.title||"").toLowerCase().includes(t)||(l.author||"").toLowerCase().includes(t),y=m.value==="all"||m.value==="available"&&f(l)||m.value==="borrowed"&&!f(l),v=Number(l.price??0),h=e===null||v>=e,N=o===null||v<=o;return r&&y&&h&&N})}),W=async t=>{var e,o;_.value=t;try{await D.post("/my/borrow",{book_id:t}),B.success("借阅成功，记得按时归还哦～"),await x()}catch(l){const r=((o=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:o.error)||(l==null?void 0:l.message)||l||"借阅失败，请稍后重试";B.error(r),console.error("借阅失败:",l)}finally{_.value=null}};Y(x);const Z=t=>t||ne,S=t=>{if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return t;const o=e.getFullYear(),l=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${o}年${l}月${r}日`},A=t=>Number(t||0).toFixed(2),R=t=>{const e=Number(t.stock_total??0);return`库存：${Number(t.stock_available??0)}/${e}`},f=t=>Number(t.stock_available??0)>0,C=t=>{const e=Number(t.stock_total??0),o=Number(t.stock_available??0);return e<=0||o>=e?"全部在馆":o<=0?"全部借出":"部分借出"},k=t=>{const e=C(t);return e==="全部在馆"?"success":e==="全部借出"?"danger":"warning"};return(t,e)=>{const o=i("el-icon"),l=i("el-input"),r=i("el-option"),y=i("el-select"),v=i("el-image"),h=i("el-tag"),N=i("el-button"),G=i("el-col"),j=i("el-row");return w(),T("div",F,[s("div",O,[s("div",null,[e[4]||(e[4]=s("h1",null,"馆藏书目",-1)),s("p",null,"共 "+c(p.value.length)+" 本图书，挑一本带回家",1)]),s("div",K,[n(l,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=a=>b.value=a),placeholder:"搜索书名 / 作者",class:"search-input",clearable:""},{prefix:u(()=>[n(o,null,{default:u(()=>[n(Q($))]),_:1})]),_:1},8,["modelValue"]),s("div",X,[n(l,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=a=>g.value=a),type:"number",min:"0",placeholder:"最低价",clearable:"",class:"price-input"},null,8,["modelValue"]),e[5]||(e[5]=s("span",{class:"price-divider"},"-",-1)),n(l,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=a=>I.value=a),type:"number",min:"0",placeholder:"最高价",clearable:"",class:"price-input"},null,8,["modelValue"])]),n(y,{modelValue:m.value,"onUpdate:modelValue":e[3]||(e[3]=a=>m.value=a),class:"filter",placeholder:"全部状态"},{default:u(()=>[n(r,{label:"全部",value:"all"}),n(r,{label:"可借阅",value:"available"}),n(r,{label:"已借出",value:"borrowed"})]),_:1},8,["modelValue"])])]),n(j,{gutter:18},{default:u(()=>[(w(!0),T(z,null,H(L.value,a=>(w(),E(G,{key:a.id,xs:24,sm:12,md:8,lg:6},{default:u(()=>[s("div",J,[n(v,{src:Z(a.cover_url),fit:"cover",class:"book-image"},{error:u(()=>e[6]||(e[6]=[s("div",{class:"book-image empty"},"No Cover",-1)])),_:2},1032,["src"]),s("div",q,[s("h3",null,c(a.title),1),s("p",ee,c(a.author),1),s("p",te,"出版："+c(S(a.publish_date)),1),s("p",ae,"定价：¥"+c(A(a.price)),1),s("p",le,c(R(a)),1),s("p",se,c(a.description||"这本书有点神秘，还没有简介~"),1),s("div",oe,[n(h,{type:k(a)},{default:u(()=>[M(c(C(a)),1)]),_:2},1032,["type"]),n(N,{size:"small",type:"primary",disabled:!f(a)||_.value===a.id,loading:_.value===a.id,onClick:ce=>W(a.id)},{default:u(()=>e[7]||(e[7]=[M(" 借阅 ")])),_:2,__:[7]},1032,["disabled","loading","onClick"])])])])]),_:2},1024))),128))]),_:1})])}}},de=P(re,[["__scopeId","data-v-fb420040"]]);export{de as default};

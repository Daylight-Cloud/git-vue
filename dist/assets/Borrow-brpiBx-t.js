import{_ as ee,r as u,v as F,o as te,c as I,b as _,d as s,e as o,w as a,s as m,g as n,m as p,j as le,y as oe,t as v,p as D,q as ae,F as P,z as H,E as B}from"./index-C2iAr7MH.js";const se={class:"borrow-root"},ne={class:"borrow-head"},ie={class:"book-cell"},re={class:"book-info"},de={class:"book-name"},ce={class:"user-cell"},ue={class:"user-info"},_e={class:"username"},me={class:"user-email"},pe={class:"time-cell"},ve={class:"time-cell"},ge={class:"action-cell"},be={class:"pagination"},h=8,fe="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGc+PHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjY0IiByeD0iOCIgc3R5bGU9ImZpbGw6I0VFRjJGRiIgLz48cGF0aCBkPSJNMCAyMCBMIDQ4IDIwIEwgNDggNDQiIHN0eWxlPSJmaWxsOiNDREU0RkYiIC8+PHRleHQgeD0iMjQiIHk9IjM3IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBzdHlsZT0iZmlsbDojOTRBO0ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWw7Zm9udC1zaXplOjEycHgiPk5PIENPVkVSPC90ZXh0PjwvZz48L3N2Zz4=",ye={__name:"Borrow",setup(we){const C=u([]),N=u([]),V=u([]),g=u(!1),r=u({book_id:"",user_id:""}),y=u(1),R=F(()=>{const e=(y.value-1)*h;return C.value.slice(e,e+h)}),w=async()=>{const e=await m.get("/borrow");C.value=Array.isArray(e)?e:[]},k=async()=>{const e=await m.get("/books");N.value=Array.isArray(e)?e:[]},S=async()=>{const e=await m.get("/users");V.value=Array.isArray(e)?e:[]},E=F(()=>N.value.filter(e=>Number(e.stock_available??e.available??0)>0)),j=()=>{r.value={book_id:"",user_id:""},g.value=!0},M=async()=>{await m.post("/borrow",r.value),B.success("借阅记录已创建"),g.value=!1,w(),k()},Q=async e=>{await m.put(`/borrow/${e}/return`),B.success("归还成功"),w(),k()},U=async e=>{await m.delete(`/borrow/${e}`),B.success("记录已删除"),w()};te(()=>{w(),k(),S()});const G=e=>e||fe,L=(e,t="")=>{if(e)return e;const c=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#F7DC6F","#BB8FCE","#85C1E2"],d=(t||"U").charCodeAt(0)%c.length,i=c[d],b=(t||"U").charAt(0).toUpperCase(),f=`<svg width="40" height="40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="${i}"/><text x="20" y="23" font-size="18" fill="white" font-family="Arial" font-weight="bold" text-anchor="middle">${b}</text></svg>`;return"data:image/svg+xml;base64,"+btoa(f)},$=e=>{if(!e||e==="null"||e==="NULL"||e===null)return"—";let t;if(typeof e=="string"&&e.includes(" ")?t=new Date(e.replace(/-/g,"/")):t=new Date(e),Number.isNaN(t.getTime()))return console.warn("无效的日期值:",e),"—";const c=t.getFullYear(),d=`${t.getMonth()+1}`.padStart(2,"0"),i=`${t.getDate()}`.padStart(2,"0"),b=`${t.getHours()}`.padStart(2,"0"),f=`${t.getMinutes()}`.padStart(2,"0"),x=`${t.getSeconds()}`.padStart(2,"0");return`${c}年${d}月${i}日 ${b}:${f}:${x}`},W=e=>{y.value=e},O=e=>(y.value-1)*h+e+1;return(e,t)=>{const c=n("el-icon"),d=n("el-button"),i=n("el-table-column"),b=n("el-image"),f=n("el-tag"),x=n("el-avatar"),J=n("el-popconfirm"),Y=n("el-table"),T=n("el-pagination"),Z=n("el-option"),z=n("el-select"),A=n("el-form-item"),X=n("el-form"),q=n("el-dialog");return _(),I("div",se,[s("div",ne,[t[5]||(t[5]=s("div",null,[s("h1",null,"借阅管理"),s("p",null,"可视化掌握借阅情况，快速审批借还")],-1)),o(d,{type:"primary",onClick:j},{default:a(()=>[o(c,null,{default:a(()=>[o(le(oe))]),_:1}),t[4]||(t[4]=p(" 发起借阅 "))]),_:1,__:[4]})]),o(Y,{data:R.value,class:"borrow-table",stripe:""},{default:a(()=>[o(i,{type:"index",index:O,label:"序号",width:"60"}),o(i,{label:"书籍","min-width":"180"},{default:a(({row:l})=>[s("div",ie,[o(b,{src:G(l.cover_url),fit:"cover",class:"cover-mini"},{error:a(()=>t[6]||(t[6]=[s("div",{class:"cover-mini empty"},"No Cover",-1)])),_:2},1032,["src"]),s("div",re,[s("div",de,v(l.book_title),1),o(f,{size:"small",type:l.status==="borrowed"?"warning":"success",class:"status-tag"},{default:a(()=>[p(v(l.status==="borrowed"?"借出中":"已归还"),1)]),_:2},1032,["type"])])])]),_:1}),o(i,{label:"借阅人","min-width":"140"},{default:a(({row:l})=>[s("div",ce,[o(x,{src:L(l.avatar,l.username),size:"small"},null,8,["src"]),s("div",ue,[s("div",_e,v(l.username),1),s("small",me,v(l.email||"—"),1)])])]),_:1}),o(i,{label:"借出时间",width:"160"},{default:a(({row:l})=>[s("div",pe,v($(l.borrow_date)),1)]),_:1}),o(i,{label:"归还时间",width:"160"},{default:a(({row:l})=>[s("div",ve,v(l.return_date?$(l.return_date):"未归还"),1)]),_:1}),o(i,{label:"操作",width:"160",fixed:"right"},{default:a(({row:l})=>[s("div",ge,[l.status==="borrowed"?(_(),D(d,{key:0,size:"small",type:"success",onClick:K=>Q(l.id)},{default:a(()=>t[7]||(t[7]=[p(" 设为已还 ")])),_:2,__:[7]},1032,["onClick"])):ae("",!0),o(J,{title:"确认删除该记录？",onConfirm:K=>U(l.id)},{reference:a(()=>[o(d,{size:"small",type:"danger"},{default:a(()=>t[8]||(t[8]=[p("删除")])),_:1,__:[8]})]),_:2},1032,["onConfirm"])])]),_:1})]),_:1},8,["data"]),s("div",be,[o(T,{layout:"prev, pager, next","current-page":y.value,"page-size":h,total:C.value.length,onCurrentChange:W},null,8,["current-page","total"])]),o(q,{modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=l=>g.value=l),title:"借出图书",width:"420px"},{footer:a(()=>[o(d,{onClick:t[2]||(t[2]=l=>g.value=!1)},{default:a(()=>t[9]||(t[9]=[p("取消")])),_:1,__:[9]}),o(d,{type:"primary",disabled:!r.value.book_id||!r.value.user_id,onClick:M},{default:a(()=>t[10]||(t[10]=[p(" 确定 ")])),_:1,__:[10]},8,["disabled"])]),default:a(()=>[o(X,{model:r.value,"label-width":"90px"},{default:a(()=>[o(A,{label:"选择图书"},{default:a(()=>[o(z,{modelValue:r.value.book_id,"onUpdate:modelValue":t[0]||(t[0]=l=>r.value.book_id=l),placeholder:"请选择图书",filterable:""},{default:a(()=>[(_(!0),I(P,null,H(E.value,l=>(_(),D(Z,{key:l.id,label:l.title,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(A,{label:"借阅用户"},{default:a(()=>[o(z,{modelValue:r.value.user_id,"onUpdate:modelValue":t[1]||(t[1]=l=>r.value.user_id=l),placeholder:"请选择用户",filterable:""},{default:a(()=>[(_(!0),I(P,null,H(V.value,l=>(_(),D(Z,{key:l.id,label:l.username,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Ce=ee(ye,[["__scopeId","data-v-851cd74d"]]);export{Ce as default};

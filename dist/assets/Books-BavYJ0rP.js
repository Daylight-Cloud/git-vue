import{_ as Y,r as _,n as S,p as ee,b as W,w as s,e as l,g as d,d as u,c as J,q as te,m as g,v as q,o as le,s as U,j as F,x as ae,y as oe,t as C,E as Z}from"./index-C2iAr7MH.js";const se={class:"cover-field"},ie={key:0,class:"cover-preview"},re=["src"],ne={__name:"BookDialog",props:{modelValue:Boolean,isEdit:Boolean,formData:Object},emits:["update:modelValue","submit"],setup(A,{emit:B}){const k=A,I=B,V=_(null),a=_({id:null,title:"",author:"",publish_date:"",price:0,stock_total:0,stock_available:0,cover_data:"",cover_preview:"",description:""}),h={title:[{required:!0,message:"请输入书名",trigger:"blur"}],author:[{required:!0,message:"请输入作者",trigger:"blur"}],publish_date:[{required:!0,message:"请选择日期",trigger:"change"}],price:[{required:!0,message:"请输入定价",trigger:"blur"}],stock_total:[{required:!0,message:"请输入总库存",trigger:"blur"}],stock_available:[{required:!0,message:"请输入可借数量",trigger:"blur"}]},v=_(k.modelValue),N=()=>{Object.assign(a.value,{id:null,title:"",author:"",publish_date:"",price:0,stock_total:0,stock_available:0,cover_data:"",cover_preview:"",description:""})};S(()=>k.modelValue,i=>{v.value=i}),S(v,i=>{I("update:modelValue",i)}),S(()=>k.formData,i=>{i?Object.assign(a.value,{id:i.id||null,title:i.title||"",author:i.author||"",publish_date:i.publish_date||"",price:Number(i.price??0),stock_total:Number(i.stock_total??0),stock_available:Number(i.stock_available??i.stock_total??0),cover_preview:i.cover_url||"",cover_data:"",description:i.description||""}):N()},{immediate:!0}),S(()=>a.value.stock_total,i=>{Number(a.value.stock_available)>Number(i)&&(a.value.stock_available=Number(i)||0)});const y=()=>{v.value=!1},P=i=>new Promise((o,w)=>{const c=new FileReader;c.onload=()=>o(c.result),c.onerror=w,c.readAsDataURL(i)}),R=async i=>{if(!i||!i.raw)return;const o=await P(i.raw);a.value.cover_preview=o,a.value.cover_data=o},$=()=>{V.value.validate(i=>{if(i){const o={id:a.value.id,title:a.value.title,author:a.value.author,publish_date:a.value.publish_date,description:a.value.description,price:Number(a.value.price??0),stock_total:Number(a.value.stock_total??0),stock_available:Number(a.value.stock_available??a.value.stock_total??0),cover_data:a.value.cover_data||a.value.cover_preview};I("submit",o),y()}})};return(i,o)=>{const w=d("el-input"),c=d("el-form-item"),z=d("el-date-picker"),x=d("el-input-number"),D=d("el-button"),j=d("el-upload"),G=d("el-form"),M=d("el-dialog");return W(),ee(M,{title:A.isEdit?"编辑图书":"新增图书",modelValue:v.value,"onUpdate:modelValue":o[7]||(o[7]=n=>v.value=n),width:"640px",onClose:y},{footer:s(()=>[l(D,{onClick:y},{default:s(()=>o[10]||(o[10]=[g("取消")])),_:1,__:[10]}),l(D,{type:"primary",onClick:$},{default:s(()=>o[11]||(o[11]=[g("确定")])),_:1,__:[11]})]),default:s(()=>[l(G,{model:a.value,rules:h,ref_key:"formRef",ref:V,"label-width":"100px"},{default:s(()=>[l(c,{label:"书名",prop:"title"},{default:s(()=>[l(w,{modelValue:a.value.title,"onUpdate:modelValue":o[0]||(o[0]=n=>a.value.title=n),autocomplete:"off"},null,8,["modelValue"])]),_:1}),l(c,{label:"作者",prop:"author"},{default:s(()=>[l(w,{modelValue:a.value.author,"onUpdate:modelValue":o[1]||(o[1]=n=>a.value.author=n),autocomplete:"off"},null,8,["modelValue"])]),_:1}),l(c,{label:"出版日期",prop:"publish_date"},{default:s(()=>[l(z,{modelValue:a.value.publish_date,"onUpdate:modelValue":o[2]||(o[2]=n=>a.value.publish_date=n),type:"date",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"定价",prop:"price"},{default:s(()=>[l(x,{modelValue:a.value.price,"onUpdate:modelValue":o[3]||(o[3]=n=>a.value.price=n),min:0,precision:2,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"总库存",prop:"stock_total"},{default:s(()=>[l(x,{modelValue:a.value.stock_total,"onUpdate:modelValue":o[4]||(o[4]=n=>a.value.stock_total=n),min:0,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"可借数量",prop:"stock_available"},{default:s(()=>[l(x,{modelValue:a.value.stock_available,"onUpdate:modelValue":o[5]||(o[5]=n=>a.value.stock_available=n),min:0,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"封面"},{default:s(()=>[u("div",se,[l(j,{class:"cover-upload","auto-upload":!1,"show-file-list":!1,accept:"image/*",onChange:R},{tip:s(()=>o[9]||(o[9]=[u("div",{class:"el-upload__tip"},"上传本地图片，支持 jpg/png",-1)])),default:s(()=>[l(D,{type:"primary"},{default:s(()=>o[8]||(o[8]=[g("选择图片")])),_:1,__:[8]})]),_:1}),a.value.cover_preview?(W(),J("div",ie,[u("img",{src:a.value.cover_preview,alt:"cover preview"},null,8,re)])):te("",!0)])]),_:1}),l(c,{label:"简介",prop:"description"},{default:s(()=>[l(w,{type:"textarea",modelValue:a.value.description,"onUpdate:modelValue":o[6]||(o[6]=n=>a.value.description=n),autosize:{minRows:2,maxRows:4},maxlength:"180","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])}}},ue=Y(ne,[["__scopeId","data-v-d77c3882"]]),de={class:"books-root"},ce={class:"books-head"},pe={class:"books-actions"},me={class:"price-filter"},_e={class:"book-title"},ve={class:"book-desc"},be={class:"stock-status-cell"},fe={class:"stock-info"},ge={class:"action-cell"},ke={class:"pagination"},we="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBmaWxsPSJub25lIiBzdHJva2U9Im5vbmUiPgogICAgPHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiNGNUY3RkIiLz4KICAgIDxyZWN0IHg9IjAiIHk9IjQwIiB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI0Q2RTdGRSIvPgogICAgPHBhdGggZD0iTTIwIDQwIEw2MCAyMCBMIDEwMCA0MCIgZmlsbD0iI0Y1QjQ4QyIgZmlsbC1vcGFjaXR5PSIwLjgiLz4KICAgIDx0ZXh0IHg9IjYwIiB5PSIxMTEiIGZpbGw9IiM0QjNCNEMiIGZvbnQtc2l6ZT0iMjQiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5PIENPVkVSPC90ZXh0PgogIDwvZz4KPC9zdmc+",L=8,Ie={__name:"Books",setup(A){const B=_([]),k=_(""),I=_(""),V=_(""),a=_(!1),h=_(!1),v=_(null),N=async()=>{const e=await U.get("/books");B.value=Array.isArray(e)?e.map(t=>({...t,price:Number(t.price??0),stock_total:Number(t.stock_total??0),stock_available:Number(t.stock_available??0)})):[]},y=e=>{if(e===""||e===null||e===void 0)return null;const t=Number(e);return Number.isFinite(t)?t:null},P=q(()=>{const e=y(I.value),t=y(V.value),p=k.value.trim().toLowerCase();return B.value.filter(m=>{const b=(m.title||"").toLowerCase(),f=(m.author||"").toLowerCase(),E=Number(m.price??0),Q=p?b.includes(p)||f.includes(p):!0,H=e===null||E>=e,T=t===null||E<=t;return Q&&H&&T})}),R=()=>{h.value=!1,v.value=null,a.value=!0},$=e=>{h.value=!0,v.value={...e},a.value=!0},i=e=>e?typeof e=="string"?e.slice(0,10):e instanceof Date?e.toISOString().slice(0,10):e:null,o=async e=>{var t,p;try{const m={title:e.title,author:e.author,publish_date:i(e.publish_date),description:((t=e.description)==null?void 0:t.trim())||"",price:Number(e.price??0),stock_total:Number(e.stock_total??0),stock_available:Math.min(Number(e.stock_available??e.stock_total??0),Number(e.stock_total??0)),cover_data:e.cover_data||e.cover_preview||null},b=e.id||((p=v.value)==null?void 0:p.id);h.value&&b?(await U.put(`/books/${b}`,m),Z.success("图书信息已更新")):(await U.post("/books",m),Z.success("新增图书成功")),a.value=!1,N()}catch(m){Z.error(m||"操作失败")}},w=async e=>{await U.delete(`/books/${e}`),Z.success("删除成功"),N()},c=e=>e||we,z=e=>{if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return e;const p=t.getFullYear(),m=`${t.getMonth()+1}`.padStart(2,"0"),b=`${t.getDate()}`.padStart(2,"0");return`${p}年${m}月${b}日`},x=e=>Number(e||0).toFixed(2),D=e=>{const t=Number(e.stock_total??0),p=Number(e.stock_available??0);return`总数：${t} | 可借：${p}`},j=e=>{const t=Number(e.stock_total??0),p=Number(e.stock_available??0);return t<=0||p>=t?"全部在馆":p<=0?"全部借出":"部分借出"},G=e=>{const t=j(e);return t==="全部在馆"?"success":t==="全部借出"?"danger":"warning"},M=_(1),n=q(()=>{const e=(M.value-1)*L;return P.value.slice(e,e+L)}),K=e=>{M.value=e};return le(N),(e,t)=>{const p=d("el-icon"),m=d("el-input"),b=d("el-button"),f=d("el-table-column"),E=d("el-image"),Q=d("el-tag"),H=d("el-popconfirm"),T=d("el-table"),O=d("el-pagination");return W(),J("div",de,[u("div",ce,[t[6]||(t[6]=u("div",null,[u("h1",null,"图书管理"),u("p",null,"维护图书信息、封面与库存状态")],-1)),u("div",pe,[l(m,{modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=r=>k.value=r),placeholder:"搜索书名 / 作者",class:"search-input",clearable:""},{prefix:s(()=>[l(p,null,{default:s(()=>[l(F(ae))]),_:1})]),_:1},8,["modelValue"]),u("div",me,[l(m,{modelValue:I.value,"onUpdate:modelValue":t[1]||(t[1]=r=>I.value=r),type:"number",min:"0",placeholder:"最低价",clearable:"",class:"price-input"},null,8,["modelValue"]),t[4]||(t[4]=u("span",{class:"price-divider"},"-",-1)),l(m,{modelValue:V.value,"onUpdate:modelValue":t[2]||(t[2]=r=>V.value=r),type:"number",min:"0",placeholder:"最高价",clearable:"",class:"price-input"},null,8,["modelValue"])]),l(b,{type:"primary",onClick:R},{default:s(()=>[l(p,null,{default:s(()=>[l(F(oe))]),_:1}),t[5]||(t[5]=g("新增图书 "))]),_:1,__:[5]})])]),l(T,{data:n.value,class:"books-table",stripe:""},{default:s(()=>[l(f,{type:"index",label:"序号",width:"60"}),l(f,{label:"封面",width:"80"},{default:s(({row:r})=>[l(E,{src:c(r.cover_url),fit:"cover",class:"book-cover","preview-src-list":[c(r.cover_url)]},{error:s(()=>t[7]||(t[7]=[u("div",{class:"cover-fallback"},"No Cover",-1)])),_:2},1032,["src","preview-src-list"])]),_:1}),l(f,{prop:"title",label:"书名","min-width":"160"},{default:s(({row:r})=>[u("div",_e,C(r.title),1),u("p",ve,C(r.description||"暂无简介"),1)]),_:1}),l(f,{prop:"author",label:"作者",width:"120"}),l(f,{label:"出版日期",width:"130"},{default:s(({row:r})=>[g(C(z(r.publish_date)),1)]),_:1}),l(f,{label:"价格",width:"100"},{default:s(({row:r})=>[g(" ¥"+C(x(r.price)),1)]),_:1}),l(f,{label:"库存/状态",width:"180"},{default:s(({row:r})=>[u("div",be,[u("div",fe,C(D(r)),1),l(Q,{size:"small",type:G(r),class:"status-tag-inline"},{default:s(()=>[g(C(j(r)),1)]),_:2},1032,["type"])])]),_:1}),l(f,{label:"操作",width:"160",fixed:"right"},{default:s(({row:r})=>[u("div",ge,[l(b,{size:"small",onClick:X=>$(r)},{default:s(()=>t[8]||(t[8]=[g("编辑")])),_:2,__:[8]},1032,["onClick"]),l(H,{title:"确认删除该图书？",onConfirm:X=>w(r.id)},{reference:s(()=>[l(b,{size:"small",type:"danger"},{default:s(()=>t[9]||(t[9]=[g("删除")])),_:1,__:[9]})]),_:2},1032,["onConfirm"])])]),_:1})]),_:1},8,["data"]),l(ue,{modelValue:a.value,"onUpdate:modelValue":t[3]||(t[3]=r=>a.value=r),isEdit:h.value,formData:v.value,onSubmit:o},null,8,["modelValue","isEdit","formData"]),u("div",ke,[l(O,{layout:"prev, pager, next","current-page":M.value,"page-size":L,total:P.value.length,onCurrentChange:K},null,8,["current-page","total"])])])}}},he=Y(Ie,[["__scopeId","data-v-9d12709a"]]);export{he as default};
